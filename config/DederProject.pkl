module ba.sake.deder.config.DederProject

// TODO write tests https://pkl-lang.org/blog/testing-in-pkl.html#writing-tests

modules: Listing<DederModule>(modulesValidation)

hidden modulesValidation = (value: Listing<DederModule>) ->
  if (!(value.toList().map((m) -> m.id).distinct.length == value.length))
    throw("Module ids must be unique.")
  else
    true

abstract class DederModule {
  /// Module id, used in CLI and referring from other modules
  id: String(idValidation)

  /// Module root directory, relative to project root
  root: String(rootValidation) = id

  /// Source directories
  sources: Listing<String> = new Listing { "src" }

  /// Module dependencies
  moduleDeps: Listing<DederModule>

  type: ModuleType

  hidden idValidation = (value: String) ->
    if (!value.matches(Regex("^[.a-zA-Z0-9_-]+$")))
      throw("Id must be alphanumeric and can contain '_' and '-' but got: " + value)
    else
      true

  hidden rootValidation = (value: String) ->
    if (!value.matches(Regex("^[.a-zA-Z0-9/_-]+$")))
      throw("Root must be alphanumeric and can contain '_', '-', and '/' but got: " + value)
    else
      true
}

typealias ModuleType = "java" | "scala" | "scala-test" | "scala-js" | "scala-native"

open class JavaModule extends DederModule {
  type = "java"
  resources: Listing<String> = new Listing { "resources" }
  javaHome: String?
  jvmOptions: Listing<String> = new Listing {}
  javaVersion: String?
  javacOptions: Listing<String> = new Listing {}
  mainClass: String? = null
  deps: Listing<String> = new Listing {}
  javacAnnotationProcessorDeps: Listing<String> = new Listing {}
  semanticdbEnabled: Boolean = read?("env:CI") != "true" // disable in CI by default
  javaSemanticdbVersion: String = "0.11.1"
  // TODO manifest entries
}

open class ScalaModule extends JavaModule {
  type = "scala"
  scalaVersion: String(!isEmpty)
  scalacOptions: Listing<String> = new Listing {}
  scalacPluginDeps: Listing<String> = new Listing {}
  scalaSemanticdbVersion: String?
  function asTest(): ScalaTestModule = (this.toDynamic().toTyped(ScalaTestModule)) {
    type = "scala-test"
  }
}

class ScalaTestModule extends ScalaModule {
  type = "scala-test"
  testFrameworks: Listing<String> = new Listing {
    "com.novocode.junit.JUnitFramework"
    "com.github.sbt.junit.jupiter.api.JupiterFramework"
    "org.scalatest.tools.Framework"
    "org.specs2.runner.Specs2Framework"
    "munit.Framework"
    "utest.runner.Framework"
    "zio.test.sbt.ZTestFramework"
    "weaver.framework.CatsEffect"
  }
}

// TODO creates a main module with test module..
//function scalaModule

typealias ScalaJsModuleKind =  "no-module" | "es-module" | "commonjs-module"

open class ScalaJsModule extends ScalaModule {
  type = "scala-js"
  scalaJSVersion: String(!isEmpty)
  moduleKind: ScalaJsModuleKind = "no-module"
}

open class ScalaNativeModule extends ScalaModule {
  type = "scala-native"
  scalaNativeVersion: String(!isEmpty)
}


/* CROSS MODULE */
class CrossModules {
  jvm: ScalaModule
  jvm_test: ScalaTestModule
  js: ScalaJsModule
  all: Listing<DederModule> = new { jvm; jvm_test; js }
}

// helper function to create cross JS modules
// https://pkl-lang.org/blog/class-as-a-function.html
class CrossJsModules {
  _root: String
  _scalaVersion: String
  _scalaJSVersion: String
  fixed get: CrossModules = crossJsModules(_root, _scalaVersion, _scalaJSVersion)
}

const function crossJsModules(
  _root: String,
  _scalaVersion: String,
  _scalaJSVersion: String,
): CrossModules = new {
  jvm = new {
    id = "\(_root)-jvm-\(_scalaVersion)"
    root = _root
    scalaVersion = _scalaVersion
  }
  jvm_test = (jvm.asTest()) {
    id = "\(_root)-jvm-test-\(_scalaVersion)"
  }
  js = new {
    id = "\(_root)-js-\(_scalaVersion)"
    root = _root
    scalaVersion = _scalaVersion
    scalaJSVersion = _scalaJSVersion
  }
}
